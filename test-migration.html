<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Migration Paiements D√©penses</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 0;
        }
        .button:hover {
            background: #0056b3;
        }
        .success {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
        pre {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ Test Migration Paiements D√©penses</h1>
        
        <div class="info">
            <strong>Instructions :</strong><br>
            1. Assurez-vous d'√™tre connect√© sur kbgestion.xyz<br>
            2. Cliquez sur "Ex√©cuter Migration Corrig√©e"<br>
            3. V√©rifiez les r√©sultats ci-dessous
        </div>

        <button class="button" onclick="executeMigration()">
            üîß Ex√©cuter Migration Corrig√©e
        </button>

        <button class="button" onclick="executeNuclearFix()" style="background: #dc3545; margin-top: 10px;">
            üí• SOLUTION RADICALE (Supprime et recr√©e la table)
        </button>

        <div id="result"></div>
    </div>

    <script>
        async function executeMigration() {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = '<div class="info">‚è≥ Ex√©cution de la migration en cours...</div>';

            try {
                // R√©cup√©rer le token depuis localStorage (si vous √™tes sur kbgestion.xyz)
                let token = localStorage.getItem('token');
                
                if (!token) {
                    // Si pas de token, demander √† l'utilisateur
                    token = prompt('Veuillez entrer votre token d\'authentification (depuis localStorage de kbgestion.xyz):');
                    if (!token) {
                        resultDiv.innerHTML = '<div class="error">‚ùå Token requis pour l\'authentification</div>';
                        return;
                    }
                }

                const response = await fetch('https://wholesome-nourishment-production-953c.up.railway.app/api/migrate/fix-and-apply-expense-payment-migration', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (data.success) {
                    resultDiv.innerHTML = `
                        <div class="success">
                            <h3>‚úÖ Migration r√©ussie !</h3>
                            <p><strong>Message :</strong> ${data.message}</p>
                            <p><strong>Table cr√©√©e :</strong> ${data.tableCreated ? 'Oui' : 'Non'}</p>
                        </div>
                        <h4>üìã D√©tails de la migration :</h4>
                        <pre>${JSON.stringify(data.details, null, 2)}</pre>
                        <div class="info">
                            <strong>üéØ Prochaines √©tapes :</strong><br>
                            1. Rechargez votre application kbgestion.xyz<br>
                            2. Allez sur la page D√©penses<br>
                            3. Cliquez sur "Paiements" sur une d√©pense<br>
                            4. L'erreur devrait avoir disparu !
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="error">
                            <h3>‚ùå Erreur lors de la migration</h3>
                            <p><strong>Message :</strong> ${data.message}</p>
                            <p><strong>Erreur :</strong> ${data.error}</p>
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">
                        <h3>‚ùå Erreur de connexion</h3>
                        <p><strong>Erreur :</strong> ${error.message}</p>
                        <p>V√©rifiez que le backend est d√©ploy√© et accessible.</p>
                    </div>
                `;
            }
        }

        async function executeNuclearFix() {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = '<div class="error">üí• ATTENTION: Cette solution va SUPPRIMER et RECR√âER la table expense_payment_plans. Tous les paiements de d√©penses existants seront PERDUS. Continuez seulement si vous √™tes s√ªr.</div>';

            if (!confirm('‚ö†Ô∏è ATTENTION: Cette solution va supprimer TOUS les paiements de d√©penses existants et recr√©er la table. √ätes-vous s√ªr de vouloir continuer ?')) {
                resultDiv.innerHTML = '<div class="info">‚ùå Op√©ration annul√©e par l\'utilisateur.</div>';
                return;
            }

            resultDiv.innerHTML = '<div class="error">üí• Ex√©cution de la solution radicale en cours... SUPPRESSION ET RECR√âATION DE LA TABLE...</div>';

            try {
                // R√©cup√©rer le token depuis localStorage
                let token = localStorage.getItem('token');

                if (!token) {
                    token = prompt('Veuillez entrer votre token d\'authentification:');
                    if (!token) {
                        resultDiv.innerHTML = '<div class="error">‚ùå Token requis pour l\'authentification</div>';
                        return;
                    }
                }

                const response = await fetch('https://wholesome-nourishment-production-953c.up.railway.app/api/migrate/nuclear-fix-expense-payments', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (data.success) {
                    resultDiv.innerHTML = `
                        <div class="success">
                            <h3>üí• SOLUTION RADICALE R√âUSSIE !</h3>
                            <p><strong>Message :</strong> ${data.message}</p>
                        </div>
                        <h4>üìã D√©tails de l'op√©ration :</h4>
                        <pre>${JSON.stringify(data.details, null, 2)}</pre>
                        <div class="success">
                            <strong>üéØ R√âSULTAT :</strong><br>
                            ‚úÖ Table supprim√©e et recr√©√©e<br>
                            ‚úÖ Colonne ID avec gen_random_uuid() configur√©e<br>
                            ‚úÖ Contraintes et index ajout√©s<br>
                            ‚úÖ Test d'insertion r√©ussi<br><br>
                            <strong>MAINTENANT :</strong><br>
                            1. Rechargez votre application kbgestion.xyz<br>
                            2. Testez l'ajout de paiements de d√©penses<br>
                            3. L'erreur devrait √™tre D√âFINITIVEMENT r√©solue !
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="error">
                            <h3>‚ùå Erreur lors de la solution radicale</h3>
                            <p><strong>Message :</strong> ${data.message}</p>
                            <p><strong>Erreur :</strong> ${data.error}</p>
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">
                        <h3>‚ùå Erreur de connexion</h3>
                        <p><strong>Erreur :</strong> ${error.message}</p>
                        <p>V√©rifiez que le backend est d√©ploy√© et accessible.</p>
                    </div>
                `;
            }
        }

        // Auto-ex√©cution si on d√©tecte qu'on est sur le bon domaine
        if (window.location.hostname.includes('kbgestion') || localStorage.getItem('token')) {
            document.addEventListener('DOMContentLoaded', () => {
                const autoInfo = document.createElement('div');
                autoInfo.className = 'info';
                autoInfo.innerHTML = 'üîç Token d√©tect√© ! Vous pouvez ex√©cuter la migration directement.';
                document.querySelector('.container').insertBefore(autoInfo, document.querySelector('.button'));
            });
        }
    </script>
</body>
</html>
